# Gigascreen No-Flick (Render Plugin для Spectaculator и ZXSpin)
<p align="right"><a href="README.md">English</a> | <a href="README_ua.md">Українська</a> | Русский</p>

Небольшой рендер-плагин для **Spectaculator** (эмулятора ZX Spectrum), который снижает мерцание при эффектах **Gigascreen** и **3Color**, смешивая последовательные кадры с использованием заранее вычисленных таблиц (LUT) с применением гамма-коррекции. Плагин также работает в **ZXSpin**, который использует тот же RPI render-plugin API. Поскольку **Spectaculator не предоставляет runtime-настройки** для рендер-плагинов, конфигурация выполняется через простой текстовый файл по вашему выбору.

> Наилучший эффект — в Gigascreen-приложениях, где два чередующихся кадра намеренно кодируют цвет. Но в обычных динамических сценах (особенно при реальных 50 fps) смешивание соседних кадров может смягчать детали, давать лёгкий «шлейф» и в целом выглядеть менее презентабельно. Один из наиболее эффективных способов избежать этого — временно отключать обработку изображения в такие моменты, что легко сделать горячей клавишей.

> Сделано быстро и "на коленке" в процессе прототипирования собственной игры на Gigascreen (**Project AZX**: [Telegram](https://t.me/project_azx), [форум](https://spectrumcomputing.co.uk/forums/viewtopic.php?t=13101)). Я не использую Spectaculator для повседневной разработки, но он очень популярен в сообществе — поэтому появился совместимый плагин рендеринга. Исходники открыты, но развивать или усложнять проект я не планирую. Это простой «собранный на коленке» инструмент, который уже выполняет свою задачу.

---

## Что делает
- Смешивает два последовательных Gigascreen-кадра с фиксированным коэффициентом, уменьшая или смягчая мерцание.
- Если включён экспериментальный режим 3Color, плагин пытается определить такие кадры и смешивает их согласно конфигурации (с гамма-коррекцией или без неё).
- Использует заранее вычисленные 2D LUT-таблицы для каждого канала (5-бит / 6-бит для RGB565), поэтому нагрузка во время выполнения минимальна.

### Пара скриншотов

#### Gigascreen
[<img src="docs/images/screenshot-gbt269.png" width="200">](docs/images/screenshot-gbt269.png)
[<img src="docs/images/screenshot-across-the-edge.png" width="200">](docs/images/screenshot-across-the-edge.png)
[<img src="docs/images/screenshot-kpacku1.png" width="200">](docs/images/screenshot-kpacku1.png)

[<img src="docs/images/screenshot-kpacku2.png" width="200">](docs/images/screenshot-kpacku2.png)
[<img src="docs/images/screenshot-paralactika1.png" width="200">](docs/images/screenshot-paralactika1.png)
[<img src="docs/images/screenshot-paralactika2.png" width="200">](docs/images/screenshot-paralactika2.png)

#### 3Color (gamma-коррекция)
[<img src="docs/images/screenshot-3c-mk-gamma.png" width="200">](docs/images/screenshot-3c-mk-gamma.png)
[<img src="docs/images/screenshot-3c-cat-gamma.png" width="200">](docs/images/screenshot-3c-cat-gamma.png)

#### 3Color (fullbright)
[<img src="docs/images/screenshot-3c-mk-fullbright.png" width="200">](docs/images/screenshot-3c-mk-fullbright.png)
[<img src="docs/images/screenshot-3c-cat-fullbright.png" width="200">](docs/images/screenshot-3c-cat-fullbright.png)

---

## Установка

### Spectaculator
1. Скачайте бинарный файл плагина из [Releases](https://github.com/dotkoval/spectaculator-gigascreen-noflick/releases).
2. Скопируйте `gigascreen.rpi` и `gigascreen.cfg` в директорию `RenderPlugin`:
   ```
   <Spectaculator installation dir>/RenderPlugin/
   ```
3. Убедитесь, что файл конфигурации `gigascreen.cfg` находится **в той же директории**, что и сам плагин.  
Если файл отсутствует, плагин попытается создать его автоматически (при условии, что текущий пользователь Windows имеет право записи в эту директорию).
4. Запустите *Spectaculator* и включите плагин в меню рендер-плагинов:

   **Options → Display → Render Plugins**

   В секции *Display Filter* выберите **Render Plugin** (radio button), затем в списке *Render Plugins* выберите **Gigascreen No-Flick (.koval)**.

   ![Spectaculator Options Display](docs/images/screenshot-display-settings.png)

### ZXSpin
1. Скачайте бинарный файл плагина из раздела [Releases](https://github.com/dotkoval/spectaculator-gigascreen-noflick/releases).
2. Скопируйте `gigascreen.rpi` и `gigascreen.cfg` в директорию `Plugins`:
   ```
   <ZXSpin installation dir>/Plugins/
   ```
3. Убедитесь, что файл конфигурации `gigascreen.cfg` находится **в той же директории**, что и сам плагин.  
Если файл отсутствует, плагин попытается создать его автоматически (при условии, что текущий пользователь Windows имеет право записи в эту директорию).
4. Запустите *ZXSpin* и включите плагин в меню рендер-плагинов:

   **Options → Display → Effects → RPI Filter Plugin**

   В секции **TV Simulation** выберите **RPI Filter Plugin** (radio button), затем в выпадающем списке *RPI Filter to use* выберите **Gigascreen No-Flick (.koval)**.

   ![ZXSpin 0.7 Options Display](docs/images/screenshot-display-settings-zxspin.png)

---

## Настройка

Плагин использует простой текстовый файл `gigascreen.cfg`, расположенный в той же директории, что и DLL плагина.  
Если файл отсутствует, он будет создан автоматически со следующими значениями по умолчанию:
```
mode=2
gamma=2.2
ratio=0.5
motion_check=0
fullbright=0
```

### Параметры

#### `mode`
Определяет, как применяется обработка изображения:

- **0** - отключено (без смешивания).
- **1** - только режим Gigascreen (смешивание текущего и предыдущего кадра).
- **2** - Gigascreen + режим 3Color.  
  В этом режиме плагин автоматически определяет последовательности 3Color, анализируя историю кадров.

#### `gamma`
Гамма-коррекция, применяемая при смешивании цветов.  
**Рекомендуемое** значение: **2.2**, так как это соответствует поведению большинства современных мониторов.

- Диапазон: **1.0+**
- **1.0** - линейное смешивание (без гамма-коррекции)
- Значения выше **2.5** практически не дают преимуществ

  *Примечание:* числовой диапазон может выглядеть широким, но **визуальная разница довольно subtle** в контексте такого смешивания: примерно 1.8 — чуть темнее, 2.5 — чуть светлее.

  Ниже приведено изображение, позволяющее подобрать значение гаммы под ваш монитор, основываясь на том, какой цвет лучше всего совпадает с центральной полосой (чёрно-белый полосатый паттерн).

  ![Gamma Samples](docs/images/gamma-samples.png)

#### `ratio`
Коэффициент смешивания текущего и предыдущего кадра в режиме **Gigascreen**.

- Допустимый диапазон: **0.5 … 1.0**
- **0.5** → 50/50, полное устранение мерцания  
- **Значения ближе к 1.0** → больше мерцания, но сильнее «ретро-вайб» :)

> Примечание: параметр `ratio` не влияет на **Fullbright** 3Color режим.

#### `motion_check`
Выполняет простую проверку на движение, чтобы уменьшить артефакты смешивания (размытые детали) в режиме **Gigascreen**.

- **0** - отключено (всегда выполнять смешивание)
- **1** - включено (пропускать смешивание, если предыдущий кадр указывает на возможное движение)

#### `fullbright`
Определяет поведение смешивания в режиме **3Color**:

- **0** - смешивание с гамма-коррекцией (более корректное)
- **1** - аддитивное смешивание (“full bright”), физически некорректное, но может приблизиться к визуальной задумке ранних экспериментов с 3Color

---

### Горячая клавиша: быстрое переключение режима (Shift+Tab)

Плагин предоставляет быстрый способ переключать режимы обработки во время работы.  
Нажмите **Shift+Tab**, чтобы циклически переключать режимы:

- **0** - обработка отключена  
- **1** - только Gigascreen  
- **2** - Gigascreen + определение 3Color  

Это полезно в сценах, где смешивание нежелательно — например, при быстрых 50 fps скроллерах или однопиксельных горизонтальных движениях, где временное сглаживание может создавать эффект «размытости». Горячая клавиша позволяет мгновенно переключиться на тот режим, который лучше всего подходит для текущего отображаемого контента.

---

## Готовые бинарники
Готовый бинарный файл `gigascreen.rpi` доступен в разделе [**GitHub Releases**](https://github.com/dotkoval/spectaculator-gigascreen-noflick/releases) этого репозитория.

---

## Прочие замечания
- **Pixel format.** Spectaculator передаёт кадры в формате **RGB565**. На практике реальные сцены Gigascreen используют лишь **очень небольшой поднабор** из полного диапазона 65 536 цветов, поэтому LUT-таблицы могут оставаться компактными и быстрыми.
- **Configuration.** Все настройки контролируются через простой текстовый конфигурационный файл, расположенный рядом с плагином. Сам эмулятор не предоставляет runtime-настроек для рендер-плагинов.
- **Performance.** Смешивание предполагает лишь несколько обращений к таблицам на каждый цветовой канал; накладные расходы минимальны.
- **Platforms.** Разрабатывалось и тестировалось под Windows. **Сборки для macOS не поддерживаются**, так как на данный момент у меня нет возможности собрать или протестировать плагин на macOS.

---

## Сборка (опционально)

Минимальная сборка под Win32/x86 выполняется очень просто.  
В репозитории есть всё необходимое для компиляции плагина — см. скрипт `build.cmd` для точных команд сборки.

### Примечания
- Плагин должен собираться как **Win32 (x86)**.  
  Перед сборкой убедитесь, что запущен `vcvars32.bat` (или используется 32-битный Developer Command Prompt).
- Файл `.def` не требуется — `rpi.h` уже содержит `__declspec(dllexport)` для обоих экспортируемых символов.
- Отдельные бинарники для разных значений gamma или коэффициентов смешивания больше не нужны; все параметры задаются в рантайме через `gigascreen.cfg`.

---

## Ссылки / источники
- sRGB colorspace in Gigascreen: https://hype.retroscene.org/blog/graphics/808.html  
- sRGB transfer functions (linear↔sRGB): https://en.wikipedia.org/wiki/SRGB

---

## Дисклеймер
Плагин «as is», сделан попутно "на коленке" при работе над **Project AZX** ([Telegram‑канал](https://t.me/project_azx), [тред на Spectrum Computing](https://spectrumcomputing.co.uk/forums/viewtopic.php?t=13101)).
Но если у вас есть идеи/улучшения (или сравнения с CRT), не стесняйтесь создавать Issue или PR :)

.koval'2025
